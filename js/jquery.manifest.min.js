/*!
 * <%= pkg.title %> v<%= pkg.version %>
 *
 * <%= pkg.description %>
 *
 * <%= pkg.homepage %>
 *
 * Copyright <%= grunt.template.today('yyyy') %> by <%= pkg.author.name %>
 * Licensed <%= _.pluck(pkg.licenses, 'type').join(', ') %>
 */
 !function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e,t){"use strict";e.widget("mf.manifest",{options:{formatDisplay:function(e,t,n){return n?n.html():e},formatRemove:function(){return"X"},formatValue:function(e,t,n,i){return i?i.text():e},marcoPolo:!1,onAdd:null,onChange:null,onHighlight:null,onHighlightRemove:null,onRemove:null,onSelect:null,onSelectRemove:null,required:!1,separator:",",values:null,valuesName:null},_marcoPoloOptions:function(){var e=this,t=e.options;return{onFocus:function(){t.marcoPolo.onFocus&&t.marcoPolo.onFocus.call(this),e._resizeInput()},onRequestAfter:function(){e.$container.parent().removeClass("mf_busy"),t.marcoPolo.onRequestAfter&&t.marcoPolo.onRequestAfter.call(this)},onRequestBefore:function(){e.$container.parent().addClass("mf_busy"),t.marcoPolo.onRequestBefore&&t.marcoPolo.onRequestBefore.call(this)},onSelect:function(n,i){var r=!0;t.marcoPolo.onSelect&&(r=t.marcoPolo.onSelect.call(this,n,i)),r!==!1&&e.add(n,i,!0,!1)},required:t.required}},keys:{BACKSPACE:8,DELETE:46,DOWN:40,END:35,ENTER:13,HOME:36,LEFT:37,RIGHT:39,UP:38},_create:function(){var t,n,i=this,r=i.options;i.$input=n=i.element.addClass("mf_input"),i.inputName="mf_"+(n.attr("name")||e.now()),i.$container=e('<div class="mf_container" />'),i.$list=e('<ol class="mf_list" />').attr({"aria-atomic":"false","aria-live":"polite","aria-multiselectable":"true",id:i.inputName+"_list",role:"listbox"}),i.$measure=e('<span class="mf_measure" />'),i.mousedown=!1,i.mpMousedown=!1,i.inputOriginals={"aria-owns":n.attr("aria-owns"),role:n.attr("role"),width:n.css("width")},r.marcoPolo?(t=n.val(),n.val(""),i._bindMarcoPolo(),n.attr("aria-owns",n.attr("aria-owns")+" "+i.$list.attr("id")),n.val(t)):n.attr({"aria-owns":i.$list.attr("id"),role:"combobox"}),i._bindInput()._bindList()._bindContainer()._bindDocument(),n.wrap(i.$container).before(i.$list).after(i.$measure),i.$container=n.parent(),r.values&&i.add(r.values,null,!1,!0),i._addInputValues()._styleMeasure()._resizeInput()},_setOption:function(t,n){var i=this,r=i.$input;switch(t){case"marcoPolo":i.options.marcoPolo?n?r.marcoPolo("option",e.extend({},n,i._marcoPoloOptions())):r.marcoPolo("destroy"):n&&(i._bindMarcoPolo(e.extend({},n,i._marcoPoloOptions())),r.marcoPolo("list").insertAfter(r.parent()));break;case"required":i.options.marcoPolo&&r.marcoPolo("option","required",n);break;case"values":i.add(n,null,!1,!1);break;case"valuesName":i.$list.find("input:hidden.mf_value").attr("name",n+"[]")}e.Widget.prototype._setOption.apply(i,arguments)},_bindMarcoPolo:function(n){var i=this,r=i.$input,o=i.options;return n===t&&(n=e.extend({},o.marcoPolo,i._marcoPoloOptions())),r.marcoPolo(n),r.marcoPolo("list").bind("mousedown.manifest",function(){i.mpMousedown=!0}),i},_bindInput:function(){var t=this,n=t.$input,i=t.options,r=i.marcoPolo&&0===i.marcoPolo.minChars,o=[t.keys.UP,t.keys.DOWN,t.keys.HOME,t.keys.END];return n.bind("keydown.manifest",function(a){if(t._resizeInput(),!i.required&&t._isSeparator(a.which))return a.preventDefault(),void(n.val()&&t.add(n.val(),null,!0,!1));if(a.which===t.keys.ENTER)return void a.preventDefault();if(!(n.val()||r&&-1!==e.inArray(a.which,o)))switch(a.which){case t.keys.BACKSPACE:case t.keys.DELETE:var s=t._selected();s.length?t.remove(s):t._selectPrev();break;case t.keys.LEFT:case t.keys.UP:t._selectPrev();break;case t.keys.RIGHT:case t.keys.DOWN:t._selectNext();break;case t.keys.HOME:t._selectFirst();break;case t.keys.END:t._selectLast();break;default:t._removeSelected()}}).bind("keypress.manifest",function(e){!i.required&&t._isSeparator(String.fromCharCode(e.which))&&(e.preventDefault(),n.val()&&t.add(n.val(),null,!0,!1))}).bind("keyup.manifest",function(){t._resizeInput()}).bind("paste.manifest",function(){setTimeout(function(){t._resizeInput(),!i.required&&n.val()&&t.add(t._splitBySeparator(n.val()),null,!0,!1)},1)}).bind("blur.manifest",function(){setTimeout(function(){t.mousedown||t._removeSelected(),t.mpMousedown||(i.marcoPolo&&i.required?t._resizeInput():n.val()&&t.add(n.val(),null,!0,!1))},1)}),t},_bindList:function(){var t=this;return t.$list.delegate("li","mouseover",function(){t._addHighlight(e(this))}).delegate("li","mouseout",function(){t._removeHighlight(e(this))}).delegate("li","mousedown",function(){t.mousedown=!0}).delegate("li","click",function(n){e(n.target).is("a.mf_remove")?(t._removeSelected(),t.remove(e(this)),n.preventDefault()):t._toggleSelect(e(this))}),t},_bindContainer:function(){var e=this;return e.$container.bind("click.manifest",function(){e.$input.focus()}),e},_bindDocument:function(){var t=this,n=t.$input;return e(document).bind("mouseup.manifest",function(i){t.mousedown&&(t.mousedown=!1,e(i.target).is("li.mf_item, li.mf_item *")||t._removeSelected()),t.mpMousedown&&(t.mpMousedown=!1,t.options.required?t._resizeInput():n.val()&&t.add(n.val(),null,!0,!1))}),t},container:function(){return this.$container},list:function(){return this.$list},add:function(t,n,i,r){for(var o,a=this,s=a.$input,l=a.options,u=e.isArray(t)?t:[t],c=e(),d=e(),m=e(),f=function(t,n,i){c.html(t),d.html(n),m.val(i),c.append(d,m),e.when(a._trigger("add",[o,c,!!r])).then(function(e){e!==!1&&(c.appendTo(a.$list),r||a._trigger("change",["add",o,c]))})},h=0,p=u.length;p>h;h++)o=u[h],"string"==typeof o&&(o=e.trim(o)),!o||e.isPlainObject(o)&&e.isEmptyObject(o)||(c=e('<li class="mf_item" role="option" aria-selected="false" />'),d=e('<a href="#" class="mf_remove" title="Remove" />'),m=e('<input type="hidden" class="mf_value" />'),l.valuesName?m.attr("name",l.valuesName+"[]"):m.attr("name",s.attr("name")+"_values[]"),c.data("manifest",o),e.when(l.formatDisplay.call(s,o,c,n),l.formatRemove.call(s,d,c),l.formatValue.call(s,o,m,c,n)).then(f));i&&a._clearInputValue()},_addInputValues:function(){var t=this,n=t.$input,i=n.data("values"),r=n.val(),o=[];return i?o=e.isArray(i)?i:[i]:r&&(o=t._splitBySeparator(r)),o.length&&t.add(o,null,!0,!0),t},remove:function(t){var n=this,i=e();i=t instanceof jQuery?t:n.$list.children(t),i.each(function(){var t=e(this),i=t.data("manifest");e.when(n._trigger("remove",[i,t])).then(function(e){e!==!1&&(n._isSelected(t)&&n._removeSelect(t),t.remove(),n._trigger("change",["remove",i,t]))})})},values:function(){var t=this,n=t.$list,i=[];return n.find("input:hidden.mf_value").each(function(){i.push(e(this).val())}),i},destroy:function(){var n=this,i=n.$input;n.options.marcoPolo&&i.marcoPolo("destroy"),n.$list.remove(),n.$measure.remove(),i.unwrap().removeClass("mf_input").val(n._joinWithSeparator(n.values())),e.each(n.inputOriginals,function(e,n){n===t?i.removeAttr(e):i.attr(e,n)}),e(document).unbind(".manifest"),e.Widget.prototype.destroy.apply(n,arguments)},_styleMeasure:function(){var e=this,t=e.$input;return e.$measure.css({"font-family":t.css("font-family"),"font-size":t.css("font-size"),"font-style":t.css("font-style"),"font-variant":t.css("font-variant"),"font-weight":t.css("font-weight"),left:-9999,"letter-spacing":t.css("letter-spacing"),position:"absolute","text-transform":t.css("text-transform"),top:-9999,"white-space":"nowrap",width:"auto","word-spacing":t.css("word-spacing")}),e},_measureText:function(e){var t,n=this.$measure;return t=e.replace(/&/g,"&").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),n.html(t),n.width()},_maxInputWidth:function(){var e=this,t=e.$container,n=e.$input;return t.width()-(n.outerWidth(!0)-n.width())},_resizeInput:function(){var e,t=this,n=t.$input;return e=t._measureText(n.val()+"---"),n.width(Math.min(e,t._maxInputWidth())),t},_clearInputValue:function(){var e=this,t=e.$input;return e.options.marcoPolo?t.marcoPolo("change",null):t.val(""),e._resizeInput(),e},_isSeparator:function(t){var n=this.options.separator;return e.isArray(n)?-1!==e.inArray(t,n):t===n},_separators:function(t){var n=this.options.separator,i=e.isArray(n)?n:[n];return t&&(i=e.grep(i,function(e){return"string"==typeof e})),i},_firstSeparator:function(e){return this._separators(e).shift()},_splitBySeparator:function(t){var n=this._separators(!0),i=t;return n.length&&(i=t.split(new RegExp("[\\"+n.join("\\")+"]")),i=e.map(i,e.trim)),i},_joinWithSeparator:function(e){var t=this._firstSeparator(!0)||"";return e.join(t+" ")},_firstItem:function(){return this.$list.children("li:first")},_lastItem:function(){return this.$list.children("li:last")},_highlighted:function(){return this.$list.children("li.mf_highlighted")},_addHighlight:function(e){var t=this;return e.length?(t._removeHighlighted(),e.addClass("mf_highlighted"),t._trigger("highlight",[e.data("marcoPolo"),e]),t):t},_removeHighlight:function(e){var t=this;return e.length?(e.removeClass("mf_highlighted"),t._trigger("highlightRemove",[e.data("marcoPolo"),e]),t):t},_removeHighlighted:function(){return this._removeHighlight(this._highlighted())},_selected:function(){return this.$list.children("li.mf_selected")},_isSelected:function(e){return e.hasClass("mf_selected")},_addSelect:function(e){var t=this;return e.length?(t._removeSelected(),e.addClass("mf_selected").attr({"aria-selected":"true",id:t.inputName+"_selected"}),t.$list.attr("aria-activedescendant",e.attr("id")),t._trigger("select",[e.data("marcoPolo"),e]),t):t},_removeSelect:function(e){var t=this;return e.length?(e.removeClass("mf_selected").attr("aria-selected","false").removeAttr("id"),t.$list.removeAttr("aria-activedescendant"),t._trigger("selectRemove",[e.data("marcoPolo"),e]),t):t},_removeSelected:function(){return this._removeSelect(this._selected())},_toggleSelect:function(e){return this._isSelected(e)?this._removeSelect(e):this._addSelect(e)},_selectPrev:function(){var t=this,n=t._selected(),i=e();return i=n.length?n.prev():t._lastItem(),i.length&&t._addSelect(i),t},_selectNext:function(){var e=this,t=e._selected(),n=t.next();return n.length?e._addSelect(n):e._removeSelect(t)},_selectFirst:function(){return this._addSelect(this._firstItem())},_selectLast:function(){return this._addSelect(this._lastItem())},_trigger:function(e,t){var n=this,i="on"+e.charAt(0).toUpperCase()+e.slice(1),r=n.widgetEventPrefix.toLowerCase()+e.toLowerCase(),o=n.options[i];return n.element.trigger(r,t),o&&o.apply(n.element,t)}})});
